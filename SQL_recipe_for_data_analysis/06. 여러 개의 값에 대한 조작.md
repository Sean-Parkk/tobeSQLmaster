# 06. 여러 개의 값에 대한 조작
[:no_toc]

{:toc}

## 새로 알게된 것
* SIGN()
  * 양수 1, 음수 -1, 0은 0 반환 (NULL은 NULL)
  * 응용) 통계량 구할 때, 0 혹은 NULL값을 제외하고 싶다면, COALESCE와 SIGN을 활용하여 분모의 수 조정
* NULLIF()
  * IFNULL()과 반대
  * IFNULL(COL1, 값)
    * 해당하는 값을 NULL로 변경
* DATE_ADD(), DATE_SUB()
  * 날짜, 시간 계산하기
  * DATE_ADD(COL, INTERVAL 1 DAY)
* DATEDIFF()
  * 날짜끼리 차이
  * DATEDIFF(COL1, COL2)
* TRUNCATE()
  * 내림

## 쿼리
### 문자열 연결하기
```SQL
SELECT USER_ID, CONCAT(PREF_NAME, CITY_NAME) AS PREF_CITY
FROM MST_USER_LOCATION;
```

### 분기별 매출 증감 판정
```SQL
SELECT
YEAR
, Q1
, Q2
, CASE
	WHEN (Q2-Q1) > 0 THEN '+'
    WHEN (Q2-Q1) < 0 THEN '-'
    ELSE ''
    END AS JUDGE_Q2_Q1
, Q1-Q2 AS DIFF_Q2_Q1
, SIGN(Q2-Q1) AS SIQN_Q2_Q1
FROM QUARTERLY_SALES;
```

### 연간 최대/최소 4분기 매출 찾기
```SQL
SELECT
YEAR
, GREATEST(Q1, Q2, Q3, Q4) AS GREATEST_SALES
, LEAST(Q1, Q2, Q3, Q4) AS LEAST_SALES;
```

### 연간 평균 4분기 매출 계산하기
```SQL
-- 이렇게 하면 NULL값 포함 시 계산 못함
SELECT
YEAR
, (Q1+Q2+Q3+Q4) / 4 AS AVERAGE
FROM QUARTERLY_SALES
ORDER BY YEAR;

-- 이렇게 하면 NULL값 처리는 되나, 평균값 매우 낮아짐
SELECT
year
, (COALESCE(Q1, 0) + COALESCE(Q2, 0) + COALESCE(Q3, 0) + COALESCE(Q4, 0))/4 AS AVERAGE
FROM QUARTERLY_SALES
ORDER BY YEAR;

-- SIGN과 COALESCE를 적절하게 사용한 예시
SELECT
YEAR
, (COALESCE(Q1, 0)+COALESCE(Q2, 0)+COALESCE(Q3, 0)+COALESCE(Q4, 0))/
(SIGN(COALESCE(Q1, 0))+SIGN(COALESCE(Q2, 0))+SIGN(COALESCE(Q3, 0))+SIGN(COALESCE(Q4, 0))) AS AVERAGE
FROM QUARTERLY_SALES
ORDER BY YEAR;
```

### 정수 자료형의 데이터 나누기
```SQL
SELECT
DT
, AD_ID
, CLICKS / IMPRESSIONS AS CTR
, 100 * CLICKS / IMPRESSIONS AS CTR_AS_PERCENT
FROM ADVERTISING_STATS
WHERE DT = '2017-04-01';
```

### 0으로 나누는 것 피하기
```SQL
SELECT
DT
, AD_ID
, CLICKS / IMPRESSIONS * 100 AS CTR_AS_PRECENT
, CASE
	WHEN IMPRESSIONS = 0 THEN 0
    ELSE CLICKS / IMPRESSIONS * 100
    END AS CTR_AS_PRECENT_BY_CASE
, 100 * CLICKS / NULLIF(IMPRESSIONS, 0) AS CTR_AS_PRECENT_BY_NULL
FROM ADVERTISING_STATS;
```

### 절대값, RMS 계산하기
```SQL
SELECT
ABS(X1 - X2) AS ABS
, SQRT(POWER(X1 - X2, 2)) AS RMS
FROM LOCATION_1D;
```

### 유클리드거리 구하기
```SQL
SELECT
SQRT(POWER(X1 - X2, 2) + POWER(Y1 - Y2, 2)) AS L2_DISTANCE
FROM LOCATION_2D;
```

### 시간 계산하기
```SQL
SELECT
USER_ID
, TIMESTAMP(REGISTER_STAMP) AS REGISTER_STAMP
, DATE_ADD(TIMESTAMP(REGISTER_STAMP), INTERVAL 1 HOUR) AS AFTER_1_HOUR
, DATE_SUB(TIMESTAMP(REGISTER_STAMP), INTERVAL 30 MINUTE) AS BEFORE_30_MINUTES
, DATE(TIMESTAMP(REGISTER_STAMP)) AS REGISTER_DATE
, DATE(DATE_ADD(TIMESTAMP(REGISTER_STAMP), INTERVAL 1 DAY)) AS AFTER_1_DAY
, DATE_SUB(DATE(TIMESTAMP(REGISTER_STAMP)), INTERVAL 1 MONTH) AS BEFORE_1_MONTH
FROM MST_USERS_WITH_DATES;
```

### 날짜 데이터들의 차이 계산하기
```SQL
SELECT
CURRENT_DATE AS TODAY
, DATE(REGISTER_STAMP) AS REGISTER_DATE
, DATEDIFF(CURRENT_DATE, DATE(REGISTER_STAMP)) AS DIFF
FROM MST_USERS_WITH_DATES;
```

### 사용자의 생년월일로 나이 계산하기
```SQL
SELECT
USER_ID
, DATE(REGISTER_STAMP) AS REGISTER_DATE
, BIRTH_DATE
, TRUNCATE(((REPLACE(SUBSTR(DATE(REGISTER_STAMP),1, 10), '-', '')) - (REPLACE(SUBSTR(BIRTH_DATE, 1, 10), '-', ''))) / 10000, 0) AS REGISTER_AGE
, TRUNCATE(((REPLACE(SUBSTR(CURRENT_DATE,1, 10), '-', '')) - (REPLACE(SUBSTR(BIRTH_DATE, 1, 10), '-', ''))) / 10000, 0) AS CURRENT_AGE
FROM MST_USERS_WITH_DATES;
```
